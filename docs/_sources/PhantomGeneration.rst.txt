Phantom Generation
==================

Before following these instructions, please make sure you have followed the instructions for setting up FreeCAD.
:ref:`_free_cad_setup`
The phantom design is based on a series of stacked slices. An individual slice is generated by calling the PhantomBuilder.AddSlice code.
A simple  script to generate a single slice is below::


	from pathlib import Path
	import importlib
	import numpy as np
	this_directory = Path(__file__).parent
	import sys, os

	path_to_source = str(this_directory / 'DistortionCorrection')
	sys.path.insert(0, path_to_source)
	importlib.invalidate_caches() # maybe is not needed
	import PhantomBuilder  # note the slightly clumsy import; we have to do it like this so FreeCAD finds the module
	importlib.reload(PhantomBuilder)
	import numpy as np
	'''
	This demonstrates a script to build a multisclice phantom in FreeCAD.
	This script MUST be called from FreeCAD, it will not run when called directly.
	'''

	Nslices = 11 # make this an odd number to make sure you have a slize at z=0
	SliceZPositions = np.linspace(-150, 150, Nslices)
	# the mean z position of the markers (defined by hole_depth) will define the Zposition

	# draw all the slices:
	for i, z_pos in enumerate(SliceZPositions):
		Slice = PhantomBuilder.AddPhantomSlice(slice_shape='rectangle',
									   slice_thickness=30, HVL_x=250, HVL_Y=250,
									   hole_depth=17, hole_spacing=25,
									   hole_radius=8.7/2,
									   DSV=150, z_pos=-z_pos,
									   LoadRegion={'shape': 'cylinder', 'radius': 50, 'height': 200},
									   GuideRods = {'radius': 10, 'position': 20, 'height': 370},
									   HoleCentroids='ROI_polar')

	Slice.draw_DSV()
	Slice.draw_Load()
	Slice.draw_Guide()


Specifying Marker Positions
---------------------------

Use the parameter HoleCentroids. Options are 'cartesian' or 'ROI_polar' will produce either cartesian or polar grids based on hole_spacing.
User can instead specify the location of all hole centroids as a 2D list of X/Y points
e.g. [[x1,x2,x3],[y1,y2,y3]]. The value of GridOffset will be applied to these points. 

Specifying a DSV (ROI)
----------------------

Typically MRI imaging performance is characterised within some DSV (diameter of spherical volume). 
You can specify a DSV using the argument DSV=150, where 150 is the radius of the sphere. 
Passing this (optional) argument has two effects:

1. An etch is added to each slice indicating the intersection of the DSV with the slice surface. This allows you to see which markers fall within the DSV
2. You can set HoleCetroids='ROI_polar'. This means that polar marker positions will be used which provide good coverage of the DSV surface.  

Specifying a Load Region
------------------------

In general, the RF coil requires a certain load to perform well. Since this phantom is only foam and small markers, the coil may not always be well loaded.
It is therefore advisable to add some load to the centre of the phantom. If you use oil markers, you should use an oil load (a bottle of oil you buy from the supermarket is sufficient in our experience).
Note that characterising a magnetic field in a source-free region is a boundary problem, so you are free to add load to the centre of the phantom without effecting the Spherical Harmonic fit.

The argument for adding a load region to a Slice is LoadRegion={'shape': 'cylinder', 'radius': 50, 'height': 200}, or LoadRegion={'shape': 'sphere', 'radius': 50, 'height': 200}

This will cut away that shape from each slice it intersects with. 

Adding Drawings
----------------

By default, no drawings are added in the CAD model. You can optionally add drawings to a Slice object using the following methods::

	Slice.add_full_scale_drawing(

To export this to a pdf, click on the 'view tab', go File, export to pdf.

Of course, you are also free to use FreeCAD to create your own drawings.
The techdraw workbench is what you will need to use. Below is the workflow for creating a fairly simple
technical drawing:

1. Activate Techdraw workbench
2. Set up the view you want to base the drawing on in FreeCAD
3. From the techdraw menu, select 'insert page using template'. Pick whatever template you want.
4. Select both the slice and the drawing in the 'model' tree menu, and from the techdraw menu click "insert a view"
5. You should now have a drawing with the current view of your model. You can add dimensions, cut views, detail views, etc. as you like.
